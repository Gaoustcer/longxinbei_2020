# 计算机组成原理复习

## 绪论

### 概念

#### （1）冯诺伊曼机（普林斯顿结构）

特点：以运算器为核心的体系结构

数据和指令二进制形式存放在存储器中，同一个存储器里既存放了数据又存放了指令，存储器采用统一寻址结构

指令=操作数（操作的对象）+操作码（干什么）

#### （2）哈佛结构

区别于冯机，采取指令、数据分体存储的形式，用于嵌入式设备

### 现代计算机组成结构

#### （1）以存储器为中心

#### （2）集成运算器和控制器在一个芯片上，称为CPU

#### （3）三大组成部件：CPU，Memory，I/O外设

#### （4）ALU

​	算术逻辑单元，包含寄存器ACC（累加器）、MQ（乘除法寄存器）、X（操作数寄存器）

#### （5）控制器

​	组成：PC(取指段) IR（指令寄存器） CU（控制单元，解析指令并发出控制信号）

### 指令执行过程

```mer
graph TB
	A[指令取值]-->B[指令译码]-->C[指令执行]-->M[访存]
	M-->Interrupt_Exception{"是否出现中断和异常"}
	Interrupt_Exception-->|没有中断和异常| WB[将数据写回寄存器堆]
	Interrupt_Exception-->|出现中断和异常| Exceptiondeal[处理异常和中断]
```



### 存储器

#### 功能

#### 组成：主存以及cache，按word或是byte寻址

组织：

程序和数据存放在内存中不同段（代码段 && 数据段）

读写操作 **以数据总线宽度** 为单位

工作方式：

MAR（暂存存储器地址）

MDR（暂存存储器数据）

### I/O设备

### 总线

### 硬件性能衡量参数

字长

存储容量

数据通路宽度

存储器带宽

标准测试程序

#### 主要性能参数

时钟频率

单位指令执行需要的时钟周期

响应时间：时间开始到结束的时间

吞吐率：单位时间完成工作量

## 指令系统

### 指令系统概述

#### 指令的分类

（1）微指令：多个微指令构成一条机器指令

（2）宏指令：多个机器指令构成一条宏指令

（3）机器指令：完成一个独立的算术逻辑运算

#### 指令系统：所有指令的集合

指令系统需要考虑兼容性的问题，新的指令系统要兼容旧的指令系统

向下（向前）兼容

#### CISC到RISC：二八定律，使用频率前十的指令占到所有指令的96%

#### 指令系统的性能要求：

完备性（某些指令可以通过软件实现）

有效性（指令执行效率&&访存效率）

规整性（变长指令&&定长指令）

兼容性

#### 指令系统与编程：高阶语言希望能够跨硬件平台

### 指令格式

基本格式：操作数+操作码

操作码长度可变&&固定长度：扩展操作码技术

地址码：指令源操作数的地址&&结果的地址&&下一条指令的地址（主存地址&&寄存器地址&&I/O地址）

按照地址个数分类：（1）三地址指令

​								（2）二地址指令

​								（3）单地址指令

​								（4）零地址指令

#### 指令字长&&机器字长：决定取指令需要几次

### 操作数和操作类型

多字节访存：边界对齐-加速取指令过程

大尾端&&小尾端

#### 操作类型：数据传送、算术逻辑、跳转指令、调用与返回、

**调用与返回保存现场**：（1）返回地址存放在哪

*设置专门的寄存器存放*

*子程序入口地址*

*栈顶，执行返回指令即从栈顶取回返回地址*

（2）caller saving && callee saving

调用者保存 or 被调用者保存

## chapter 2：MIPS处理器设计

### MIPS指令字结构

定长指令字

三种指令：R，I，J

寻址模式：立即寻址（I）寄存器寻址（R）基址寻址（J）伪直接寻址（J）

### Regfile：先写&&后写

### 多周期CPU实现

无条件转移的实现：PC+4的最高4位与指令字的底26位补0

单周期：CPI=1

增加寄存器，存放Instruction，Memory Data，Register File读出数据，ALU计算结果

增加PC控制信号，控制PC写入

| 指令类型       | 所需周期数 |
| -------------- | ---------- |
| R-type         | 4          |
| lw             | 5          |
| sw             | 4          |
| 条件转移指令   |            |
| 无条件跳转指令 |            |

## chapter 4：MIPS  pipeline CPU design

### 流水线技术原理

流水均匀：各个流水段duration相同

流水非均匀：各个流水段duration不同

#### 流水线的特点：瓶颈

### 流水线的分类

（1）按照流水线功能分

单功能流水线 && 多功能流水线（流水段连接方式不同）

（2）静态流水线 && 动态流水线

（3）部件级，处理机级和处理机间流水线

（4）标量流水处理 && 向量流水处理

（5）线性流水处理 && 非线性流水处理 （是否存在反馈回路）非线性存在流水线调度问题

（6）顺序执行 && 乱序执行：流出任务和流入任务是否顺序相同

### 流水线性能分析

#### 吞吐率：单位时间完成任务

最大吞吐率：流水线稳定时的吞吐率（流水段瓶颈的倒数）

实际吞吐率

#### 加速比：流水线速度和等功能非流水线速度之比

### 流水线效率：流水线设备利用率

流水线存在通过时间和排空时间，流水线各段并非满负荷工作

### MIPS五段流水线实现

EX段增加加法器计算非顺序执行的指令下一条PC

在五段流水线中，除了sw和转移指令，其余指令均需要5个周期

**问题：为何Rtype花四个周期**

### 流水线相关问题

hazard  and  dependencies

结构相关：主要因为哈佛结构导致硬件资源问题

数据相关：

控制相关

处理数据相关：bypassing and interlock(解决lw相关)

forwarding：R+R MEM->EX

lw+R：请直接stall一个周期

lw+nop+R：直接WB->EX

R+nop+lw：WB->EX

lw+nop+lw: WB->EX

R+sw:Mem->EX，

interlock：forwarding无法解决全部raw问题

interlock检测：在ID段，冻结之前的流水段，向EX段插入气泡

解决控制相关：编译调度

调度指令来源：从目标处调度（分支成功）、从失败处调度（分支失败），从前调度

分支预测：一位 or 两位 ->数据预排序，提高分支预测准确度

#### 数据相关分类：RAW（读快写慢）

WAW（后面写快，前面写慢）

WAR（后面写快，前面读慢）

消除RAW：数据定向

stall的语义：

### 流水线高级技术

## chapter 5：中断系统

### 中断的种类

异常：软硬件错误或故障

I/O：相应外设中断，实现交互

并发：多核处理器核间通讯

服务：系统调用

### 中断管理：中断服务例程ISR

RISC：exception包含（1）外部事件（2）异常（3）陷阱

外部中断和异常都是无法预知什么时候发生的，陷阱有专门指令

异常处理：可恢复异常（交给OS处理）不可恢复异常（异常终止）

### 中断机构

中断禁止or允许->PSW寄存器（程序状态字）

中断响应/请求：INTR（中断请求标记）

中断响应/返回：中断隐指令

断点/现场保存：Mem/寄存器压栈

中断服务：中断识别/判优（中断控制器）ISR入口：向量or非向量

##### 中断请求标记INTR

每一个中断源对应一个中断请求标记触发器

多个INTR组成中断请求标记寄存器

INTR既可以是分布式，也可以集中在处理器片上

##### 中断判优逻辑

（1）软件实现（程序查询）

（2）硬件实现（排队器电路）

##### 中断响应

响应中断的条件：中断允许触发器有效

何时响应中断：指令执行周期结束，增加中断周期

（1）保存程序断点

（2）服务程序入口地址

（3）硬件关中断（允许中断触发器EINT置零，中断标记触发器INT置一）

中断响应时间与条件：外部中断异步响应（指令周期结束）内部中断（同步响应）

中断周期：CPU与中断控制器通信，响应外部事件

#### 保存和恢复现场

寻找中断服务程序入口地址：（1）硬件向量法：设计硬件译码器，根据中断类型译码产生各个中断入口地址（2）软件查询

##### 多重中断

（1）提前设置开中断：将中断使能置为有效，在保存现场之后即可使能中断

（2）中断优先级

##### 屏蔽技术

（1）屏蔽触发器

（2）中断屏蔽字->在ISR中设置中断屏蔽字

### MIPS异常处理（非精确异常）

方案一：执行完已经进入流水线的指令之后再处理

方案二：将异常视为控制相关

## Chapter 6：存储器

### 概述

MAR\MDR在片上

字寻址/字节寻址

### 技术指标

存储容量

存取时间（访问时间：一次读指令发出到操作完成）

存储周期（连续两次**写**操作最小时间）

存储器带宽（字/s，字节/s，位/s）

#### 存储芯片

地址总线、数据总线、控制总线

控制线：读写控制+片选

译码驱动电路：从地址找到存储单元

译码驱动方式：线选法、重合法

线选法电路复杂，不适用与大容量存储器，将存储单元视为线性数组

重合法：线少，提高集成度

### SRAM随机存储器

基本存储单元：锁存器

读周期：读出时间（给出地址到读出有效数据花费的时间）

写周期：维持时间（写数据在写使能有效之后仍然需要维持一段时间）

### DRAM芯片

增加行列地址锁存器

读、写周期界定：行选信号两次有效之间的时间差

#### DRAM刷新

什么是刷新？将原有数据读出，再次写入

按行刷新。

##### 刷新方式：

（1）集中刷新：所有行在每一个刷新周期都被刷新，刷新时暂停读写

（2）分散刷新：刷新在正常读写周期实现，增加周期长

### ROM

可编程ROM：实现一次性编程（PROM）可擦除可编程（EPROM）

### 存储器与CPU如何连接？

对存储芯片进行扩展：位扩展、字扩展

## cache

### cache line：Cache-line size 

什么是cache line：一般cache与主存单元之间的映射不是字到字的映射，而是块和块的映射，块的大小称为一个cache line

一次取一个cache line 大小的数据，将内存划分为多个cache line

结构：tag+block（k个字）+control bit

control bit：（1）有效位（valid)：标c记数据是否有效（开始 && 进程切换 导致数据失效）

（2）重写位(Dirty)：数据是否修改？（用于同步cache和主存的信息）

（3）计数位(count)：替换算法

| parameter           | general value  |
| ------------------- | -------------- |
| cache line size     | 4-128 byte     |
| hit time            | 1-2 CPU cycle  |
| miss time           | 8-100 CPU time |
| data transform time | 2-40 CPU time  |
| miss rate           | 0.5%-10%       |
| cache size          | 1KB-1MB        |



Tag：块号，内存中映射

cache 效率：影响效率的因素，主要是容量和块长

### cache miss：读cache过程

Icache miss：stall整个处理器,冻结PC和段间寄存器

减少cache miss的策略：（1）early restart：从数据块开始处读取，请求字返回就重新开始取指令

（2）request word first：先取回请求字，再重新取指，再取回剩余数据

Dcache 预取(One Block Lookahead)：b miss，同时调入b和b+1

### write policy（Dcache）

#### 命中：write through && write back（只写cache，置dirty位）

缺失：write allocate（换入cache并修改cache）no write allocate（直接写下一级存储器）

多处理器cache：使无效法，置其他处理器的cache valid位为0

#### 多处理器访存一致性问题（ABA）

### cache与主存的映射

n位地址=m主存块号+b块内字地址

##### 全相联

字块位置任意，比较次数多

设主存有2^m个块，cache有2^c个块，主存和cache块大小相同。主存访问地址可以分为两个部分，块号和块内偏移，tag为m位，需要比较块地址

##### 直接映射

将主存按照cache块数分段，比较器逻辑简单

缺点：冲突，效率低

##### N路组相联





